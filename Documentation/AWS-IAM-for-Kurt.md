# Setting up IAM on AWS
This document details a basic IAM setup that enables a team to create and manage EC2 instances on an account owned by a third party (in this case, intended to be the client).

This setup does *not* use the IAM Identity Center and organizations. The advantage of avoiding these is simplicity, but this comes at the cost of poor scaling for organizations (lots of busywork if you do this for 100 people) and low granularity of permissions (usually giving more permissions than are strictly necessary to simplify things). **In particular, this second one could be an issue. This setup gives full admin access. Make sure you trust your team and that they will secure the credentials appropriately!**

If you wish to use the IAM Identity Center, the best place to start is AWS's full user documentation [here](https://docs.aws.amazon.com/SetUp/latest/UserGuide/setup-overview.html). Make sure to click the stuff in the left sidebar - there are many subpages to this.

## Preparation
Create an AWS account using the instructions [here](https://docs.aws.amazon.com/SetUp/latest/UserGuide/setup-prereqs-instructions.html). Note that you will most likely need to wait a day or two for them to verify payment info.

It is **strongly** recommended that you [create a budget](https://docs.aws.amazon.com/cost-management/latest/userguide/budget-templates.html) after you do so so that you will get notification if something goes wrong with costs.

## Creating an EC2 admin user for someone else
These instructions will allow you to create an admin user solely for EC2 instance access. In theory, this should be more than enough to manage the project deployment. One disadvantage to this approach is that if you use it with multiple teams, they may be able to see and manage (accidentally or otherwise) each other's instances. However, this approach is the simplest to get things functioning.

### General process

1. Navigate to the IAM dashboard: Search "IAM" and select "IAM" ![IAM should be the first search result](<../Auxiliary Files/Images/AWS_Images/IAM-navigation.png>)
2. Note the sidebar on the left. There are two entries we care about, both under "Access Management": "User groups" and "Users".
![Users and user groups are early entries in the sidebar](<../Auxiliary Files/Images/AWS_Images/IAM-sidebar.png>)
3. Begin [creating a group](#create-a-group) if you have not already by clicking "User groups" and then the yellow "Create group" button in the upper right.
4. Once you have created a group, begin [creating one or more users](#create-a-user) as needed by clicking "Users" and then the yellow "Create user" button in the upper right.

### Create a group
You should only need to do this once with the current setup. Do this before creating users to simplify the process.

1. After clicking the "Create group" button, give the group a meaningful name, probably related to EC2 management.
2. Select the "AmazonEC2FullAccess" permission policy. Searching for it by name can be very helpful. ![AmazonEC2FullAccess description should start with "Provides full access to Amazon EC2 via the AWS Management Console"](<../Auxiliary Files/Images/AWS_Images/IAM-ec2-management-group.png>)
3. Do not attach any more policies.
4. Click the yellow "Create group" button in the lower right when you are done. Make sure you remember the approximate name of the group.
 

### Create a user
1. After clicking the "Create user" button, give the user an appropriate name. This will be the username for your team/team members later. Select the box labeled "Provide user access to the AWS management console", then select "I want to create an IAM user", even if it is not recommended (it is simpler). Either option for "Console password" works, you can leave it as autogenerated, but you should require the password to change on next login.
![Check the "Provide user access to the AWS management console " box and the other options should appear.](<../Auxiliary Files/Images/AWS_Images/IAM-user-basics.png>)

Go to the next page.
2. Add the user to a group. That group should be the EC2 management group you created earlier. Do not worry about permissions boundary options.
![Add a group and select only the EC2 management group by name.](<../Auxiliary Files/Images/AWS_Images/IAM-user-group-add.png>)

Go to the next page.
3. Review the details of the user on the page.
![You should see your permissions group and the IAMUserChangePassword policy.](<../Auxiliary Files/Images/AWS_Images/IAM-user-summary.png>)

If they look good, click the yellow "Create user" button in the lower right.
4. **Do not leave this page just yet!** Make sure you copy all three fields using the highlighted buttons. You cannot return to this page once you have left it and will need to recreate the user if you forget their details.
![Copy buttons are two overlayed squares to the left of each field..](<../Auxiliary Files/Images/AWS_Images/IAM-user-final.png>)

Put the credentials in a secure location for distribution later.
5. Once you have secured the user credentials you may leave the page and are done creating the user. If you need to create more than one user, repeat these steps as necessary.

## Distributing credentials
Once you have created the user and saved the credentials, you will need to share them with the intended user(s). You should do this through secure channels - Zoom is preferred over email (email may not be encrypted, which could be a problem), but the meeting should *not* be recorded if this is the case.

Remember that these credentials provide admin management access on your AWS account. If compromised, they could allow for tampering with or deleting of EC2 instances (the machines running the app), as well as creation of malicious ones to distribute malware or run up your bill. **Make sure you trust anyone you distribute these credentials to and make sure they are distributed through secure channels.** One of the best things you can do is make sure that when you generate passwords, they are forced to change at next login. This makes it so that if whatever medium you used to transfer them is hacked later, the password for the account will have change and is not compromised by the loss of the original, generated password.

 Additionally, **make sure any future team understands the seriousness of the security of the management credentials.** Revoke credentials when they are no longer needed using the instructions [here](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_manage.html#id_users_deleting_console).

# Other stuff worth noting
While IAM access is necessary to manage deployment and is the main purpose for this document, we have included some instructions for managing costs if a team makes a mistake, as well as references for future domain name deployment.

## Shutting down EC2 instances as root
If an EC2 instance is left up by mistake, it can run out hours and run up prices. Here is how you should shut it down as the root user.

1. Go to EC2: ![Search EC2 in the search bar and click "EC2"](<../Auxiliary Files/Images/AWS_Images/EC2-navigation.png>)
2. Click on "Instances (running)"
   
   ![Instances running is in the center of the page usually](<../Auxiliary Files/Images/AWS_Images/EC2-management.png>)

4. Select each instance with the checkbox and then access the "Instance state" dropdown. Select "Stop instance".
![Stop instance in dropdown](<../Auxiliary Files/Images/AWS_Images/EC2-instance-stop.png>)
**Be sure not to select "terminate instance" because this will delete the entire image! Of course, this may be something you want to do if you are done with this account.** Accidentally leaving instances running is the most common way you can lose money.

### Other EC2 stuff laying around
If these is other EC2 stuff costing you money, here are some basic troubleshooting instructions. Consult AWS tech support if these do not work.

1. Go to the AWS EC2 Dashboard where you selected "Instances (running)".
2. Under normal deployment, there may be instances (running or not), volumes, security groups, and key pairs. **There shouldn't be anything else.**
3. If there are security groups or key pairs, these shouldn't cost you anything.
4. Under instances, if there are instances costing you money, terminate them from the same menu that you stop them under.
5. If there are volumes, delete all instances with them first, detach them if necessary using the dropdown menu "actions" much like the dropdown for stopping instances, and finally delete them from that same dropdown. ![delete volume in dropdown](<../Auxiliary Files/Images/AWS_Images/EC2-delete-volume.png>)
6. For anything else: your team has either made some mistakes or failed to update this documentation. Consult [these instructions](https://repost.aws/knowledge-center/delete-terminate-ec2) to delete all other items.


## Adding a domain name
**NOTE: These instructions are still experimental at this point.** They are mostly intended to be a starting point for our work or a future team.

### Registering with Route 53
As far as we can tell, this most likely should be done from the root account by its owner. See [Amazon's instructions for this](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html).

### Routing from Route 53 domain name to an EC2 instance
See [Amazon's instructions](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-ec2-instance.html). In theory, this should only need EC2 access and may be done by the deployment team.

### Sending emails from a Route 53 domain
While we cannot verify these instructions at this time due to a lack of a domain to work from, they may be useful for a future team. See [this](https://charlescampbell599.medium.com/setting-up-a-custom-domain-and-email-address-with-aws-ses-e9d39042e192). This will most likely need to be done by the organization handling day-to-day operations with the site.
